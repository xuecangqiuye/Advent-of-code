import java.util.*;

public class Day6 {

    public static void main(String[] args) {
        String input = ".........................................#...............................#..........#.......................#.....................\n" +
                "................#.........................................#.................................#..........#...#......................\n" +
                "......................#...#............#..................#......................#.##........#............#.......................\n" +
                "...........................#...............................##.................#..............#............#.......................\n" +
                "..........#....#...............#.........#.................................#.......#.....................#..........#..........#..\n" +
                "..........................................#..............#...............................#.......................#................\n" +
                ".................#..#..........#.#..................#................................#.......#.#........#....#....#...............\n" +
                ".......#............#....................................#..#.....##...............................#........##...........#........\n" +
                "......#..................................................#.....#..................#......................................#........\n" +
                "....................................................................................................#...#.......#.............#...\n" +
                ".....#...................................................#...........#...##........##.................................#...........\n" +
                "........................#..........................#...............#.......#............#..#..........##..............#...........\n" +
                ".....................#...................................#.........................#..............#......#..................#.....\n" +
                ".........#.#....#.....#...................................#....................................#..................................\n" +
                ".........#.#......#.........................#............................................#...#...................................#\n" +
                ".........................................#.#...............................#..............#..............................#........\n" +
                "#...........#...................#.....#..................#.........#...#...................#.............................##.....#.\n" +
                "#....#..........#............#................................#...#............##.....#....................#......................\n" +
                "#.................................##...#........#..............#.......#..........#....................................#.........#\n" +
                "..............#...#...............................................#................#........#...#.................#......#........\n" +
                "..............#.....................#.....#...........#............#...#.......##.........................##.#....................\n" +
                "....#............................................##...................#.......................................#........#..........\n" +
                ".................................................................................#...#............................................\n" +
                "....................................#...................#.........#......#.....#...#.............................#..............#.\n" +
                ".....#................................#................................#........................................................#.\n" +
                ".............................................#..........##........#.........#..........................#..........................\n" +
                "...............#..#...........#.......#........................#.........#.....................................................##.\n" +
                "...#....................#.........................#..#............................#...........#..#...#...............#............\n" +
                "........#.....................................#.......................................................#...#..#.........#.#......#.\n" +
                "...........................................#...............#............................................................#.....#...\n" +
                ".........................................#.....#............##......................#..............................#..............\n" +
                "..#...............#.............................#............................#.........#.......#..................................\n" +
                "..............................................................................................................#.............#....#\n" +
                "..................#.#.............#......................................#.......#...............#..........#.....................\n" +
                "........................#.#.......#..........#...#......#.........#......#.................#........#.......#............#....#.#.\n" +
                "..#.....................................................................#......................#...............#..................\n" +
                "..................................................................#......#............................#........#........#.........\n" +
                "......................................#.....................#..................#..............#...................................\n" +
                "................#..#.....................................................#....................................#..........#........\n" +
                "...................................#........................................#.#..#............................................##..\n" +
                "...............................#.........................#..........................#............................#.........#......\n" +
                "............................#........#..............#.............#.#........................................................#....\n" +
                "................#..................#.....#......................#.....................................................#...........\n" +
                "......................#........#............#..................#...............#...............#..................................\n" +
                "......................................................#..................................................#........................\n" +
                "................#.......#..................................................................#......................................\n" +
                "....................................#....#...............#........................................................................\n" +
                ".................................................................................................#...#.#..........................\n" +
                ".......#..#...........#.....#...............................................................................#..............#......\n" +
                "...#.................#.................^...................#.....#................................................................\n" +
                "...............#.............................................................................#.................................#..\n" +
                "............................................#.....#............................................................#.#........##......\n" +
                "................................#................................#.......#..#......#...................#......#..............#....\n" +
                "...................##...........................................................#.................................................\n" +
                "...........................#...................#..........#...................................#............#.............#...#....\n" +
                ".....#........................#...............#..#.#.......#...................................#.##...............#...#...........\n" +
                "...#.....................#.#.......................#..........#.............................................................#.....\n" +
                ".......#.........................................#.........#.............#....................##...........................#......\n" +
                ".......................................##...........#.................#.......................................#..................#\n" +
                "................................#.......#..........................#........#.#........#..........#...........#....##.............\n" +
                ".......#............#....#....................................#.....#...............#.............................................\n" +
                "..........#.................#............................................................................#.............#....#...#.\n" +
                "...#.......................#.................................................................................................#....\n" +
                ".......................#....#..........................................................................................#..........\n" +
                "......................................................................#...............................#............#....#.........\n" +
                ".....#..............................................................................#............#...........................#....\n" +
                "..#.............#..#.............#...#............................................................................................\n" +
                "....................................................#.......#.............................#....#............#...................#.\n" +
                "....................................................................#.#...#....................................#..........#.......\n" +
                "......#...#................#.........#.................##......................#........................#.........................\n" +
                ".............#.#...........#..........................................................................#...........................\n" +
                "..........#.....#........#........................................................................#.#.................#...........\n" +
                "..........#.##....................................#......#................#..........#..........#.......##.....#..................\n" +
                ".............................#................................................................##.............#....................\n" +
                "....................................#.................................................................................###.........\n" +
                "..................................#..........#...................................#......#.........................................\n" +
                "...............#...........#.............................................#......#...................................#.............\n" +
                "...............#...#...................................................#...................#............#...................#.....\n" +
                "........................................#......#.............#........#..........................#....#.....#..................#..\n" +
                ".......................#......................................................................#.......#...................#.....##\n" +
                ".................#.....................#............#............................#..........#......................#..............\n" +
                "....................#................................................................#................#......#.#..................\n" +
                ".#............#...............................................#..#......##.#................................##....#...............\n" +
                ".#.......#..........................................................................................................#.............\n" +
                ".................#............#...............................................................................#...................\n" +
                ".................................##......................................#.........................#................#.............\n" +
                "...................#.............................................................#................................................\n" +
                "...#.....#..#......#........#....#.................#..................#..#......................................#...........#...#.\n" +
                ".#.....................#...........................................................................#............................#.\n" +
                ".#............................#.........#...............................................#.........................................\n" +
                "....#......................#......................#....#........#.....#...................................#......................#\n" +
                ".......#.................#..............................#.....#......................#...............#..............#.......#.....\n" +
                "...#.................................................................................................#........#.....#......#......\n" +
                "......##...................................................................................#................................#.....\n" +
                "..........#................................#..................................#.................................................#.\n" +
                "...........#........#..............#...#..............#...................................................#......#.........#......\n" +
                ".......#...#....................................#..##.........................................................#...................\n" +
                "...........#............................................##..........#..#.#.....................................................#..\n" +
                "...................................#............................#..............#..#..................................#............\n" +
                "....#.......#...............#...........................................................................#.........................\n" +
                "...............#.....................................................................................................#............\n" +
                "................#..........................................#...............##...........................#....#..........#.........\n" +
                "...........................................#...................................................................................#..\n" +
                ".................#..........................................................................#.....#.............##..........#.....\n" +
                "...............#..................#................................#.......................#...#.....##...........................\n" +
                ".............#.......................#.......#.............#.#...#......#..............#.............................#.#..........\n" +
                "..........##....#..#..............................#...............................................................................\n" +
                ".................#......#.......#.....#..........#.............................#......................#.....#.....................\n" +
                "....#........#....................#.#.........#.#..........#......................................................................\n" +
                "...........................#.......#........#.........................#.#.................#........#...............#......#.......\n" +
                "#..#..................#...........#.....................................................................................#.........\n" +
                "......#...#.#...........#.....................................................#................#..#............#..................\n" +
                "................##.#...#..............#..............................#............................................................\n" +
                "...........................................................................................#.............................#........\n" +
                ".......#....#...................#..........................................................#............#............#.....#......\n" +
                ".............#....#..................................#....#........#.....................................#.#....#..............#.#\n" +
                ".#..................................................#...................#...............#.........................................\n" +
                "...#........#..................................#............#.#.......................................#...........................\n" +
                "................#.....#....................................#.#.#...........#......##................#.................#......#....\n" +
                "...#.......................#...........#...#...........#.#........................#..#.................##.....#...................\n" +
                ".............#.......................................#................#....#..#..#.....................#...#............#.........\n" +
                "..........#..................#............#...#..................#................................................................\n" +
                ".........#..........#.....................#..#................#.......................#.........#.......##..#.#....#.....#....#...\n" +
                "#..........................#.#...........#.#.........#............................................................................\n" +
                "..................#.....................#......#.##...................#................................................#..#.......\n" +
                ".....#....#......#..#............................##.........................................................#.....#.......#...##..\n" +
                "....#...#.#...##..................#..........................................................#.....#..............................\n" +
                "..............................#............#...........#..................................#....#............#.......#.............\n" +
                "....................................#.....................#............................#..............#...........................\n" +
                "............#............#..........#....##....................................#..#.....#..................#......................";

        String input1 = "....#.....\n" +
                ".........#\n" +
                "..........\n" +
                "..#.......\n" +
                ".......#..\n" +
                "..........\n" +
                ".#..^.....\n" +
                "........#.\n" +
                "#.........\n" +
                "......#...";

        String[] split = input.split("\\n");
        char[][] map = new char[split.length][split[0].length()];
        Character[][] map1 = new Character[split.length][split[0].length()];

        for (int i = 0; i < split.length; i++) {
            for (int j = 0; j < split[i].toCharArray().length; j++) {
                map[i][j] = split[i].charAt(j);
                map1[i][j] = split[i].charAt(j);
            }
        }
        int step = solutionForPartOne(map);
        System.out.println(step);

        int answer2 = solutionForPartTwo(map1);
        System.out.println(answer2);
    }

    static char GUARD = '^';
    static char WALL = '#';
    static int[][] DIR = new int[][]{
            {0, -1},
            {1, 0},
            {0, 1},
            {-1, 0}
    };
    static int LENGTH_X = 0;
    static int LENGTH_Y = 0;
    static char MARK = 'X';

    public static int solutionForPartOne(char[][] map) {
        int res = 0;
        int x = 0;
        int y = 0;
        LENGTH_Y = map.length;
        LENGTH_X = map[0].length;
        for (int i = 0; i < map.length; i++) {
            for (int j = 0; j < map[i].length; j++) {
                if (Objects.equals(map[i][j], GUARD)) {
                    x = j;
                    y = i;
                }
            }
        }
        map[y][x] = MARK;
        dfs(map, x, y, 0);

        for (char[] chars : map) {
            for (char a : chars) {
                if (Objects.equals(a, MARK)) {
                    res++;
                }
            }
        }
        return res;
    }

    public static void dfs(char[][] map, int x, int y, int dir) {
        int[] dirArr = DIR[dir];
        int nextX = x + dirArr[0];
        int nextY = y + dirArr[1];


        if (nextY >= LENGTH_Y || nextY < 0 || nextX >= LENGTH_X || nextX < 0) {
            return;
        }
        if (Objects.equals(map[nextY][nextX], WALL)) {
            dir = (dir + 1) > 3 ? 0 : dir + 1;
            dfs(map, x, y, dir);
        } else {
            map[nextY][nextX] = MARK;
            dfs(map, nextX, nextY, dir);
        }
    }


    static int RES2 = 0;
    static char FAKE_WALL = '@';
    static int INIT_X;
    static int INIT_Y;

    public static int solutionForPartTwo(Character[][] map) {
        int x = 0;
        int y = 0;
        for (int i = 0; i < map.length; i++) {
            for (int j = 0; j < map[i].length; j++) {
                if (Objects.equals(map[i][j], GUARD)) {
                    x = j;
                    y = i;
                }
            }
        }
        map[y][x] = MARK;
        INIT_X = x;
        INIT_Y = y;

//        dfs2(map, x, y, 0);
        return dfs3(map);
//        return RES2;
    }

    static Character[][] copyArr;
    static int COUNT = 0;
    static int LIMIT = 10000;
    static boolean USE_FAKE_WALL = false;


    public static void dfs2(Character[][] map, int x, int y, int dir) {
        int[] dirArr = DIR[dir];
        int nextX = x + dirArr[0];
        int nextY = y + dirArr[1];
        int nextDir = (dir + 1) % 4;

        if (COUNT > LIMIT) {
            RES2++;
            return;
        }

        if (nextY >= LENGTH_Y || nextY < 0 || nextX >= LENGTH_X || nextX < 0) {
            return;
        }

        if (Objects.equals(map[nextY][nextX], WALL) || Objects.equals(map[nextY][nextX], FAKE_WALL)) {
            dfs2(map, x, y, nextDir);
        } else {
            if (!USE_FAKE_WALL) {
                USE_FAKE_WALL = true;
                copyArr = Day16.deepCopyArray(map);
                copyArr[nextY][nextX] = FAKE_WALL;

                dfs2(copyArr, x, y, nextDir);

                USE_FAKE_WALL = false;
                COUNT = 0;
            } else {
                COUNT++;
            }
            map[nextY][nextX] = MARK;
            dfs2(map, nextX, nextY, dir);
        }
    }

    public static int dfs3(Character[][] map) {
        int loops = 0;
        for (int i = 0; i < LENGTH_Y; i++) {
            for (int j = 0; j < LENGTH_X; j++) {
                if (map[i][j] != '.') {
                    continue;
                }

                // clone the map and set the current cell to an obstacle
                Character[][] copyMap = Day16.deepCopyArray(map);
                copyMap[i][j] = '@';

                // run the map until we run off the map or hit our step limit
                int steps = 0;
                int dir = 0;
                int x = INIT_X;
                int y = INIT_Y;

                while (steps < LIMIT) {
                    int[] dirArr = DIR[dir];
                    int nextX = x + dirArr[0];
                    int nextY = y + dirArr[1];

                    if (nextY >= LENGTH_Y || nextY < 0 || nextX >= LENGTH_X || nextX < 0) {
                        break;
                    }
                    if (Objects.equals(copyMap[nextY][nextX], WALL) || Objects.equals(copyMap[nextY][nextX], FAKE_WALL)) {
                        dir = (dir + 1) % 4;
                        continue;
                    } else {
                        x = nextX;
                        y = nextY;
                    }
                    steps++;
                }

                // if we hit our step limit, assume we've found a loop
                if (steps >= LIMIT) {
                    loops++;
                }

            }
        }
        return loops;
    }

}

// https://observablehq.com/collection/@jwolondon/xadvent-of-code-2024

