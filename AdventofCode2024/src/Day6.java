import java.util.*;
import java.util.stream.Collectors;

public class Day6 {

    public static void main(String[] args) {
        String input = ".........................................#...............................#..........#.......................#.....................\n" +
                "................#.........................................#.................................#..........#...#......................\n" +
                "......................#...#............#..................#......................#.##........#............#.......................\n" +
                "...........................#...............................##.................#..............#............#.......................\n" +
                "..........#....#...............#.........#.................................#.......#.....................#..........#..........#..\n" +
                "..........................................#..............#...............................#.......................#................\n" +
                ".................#..#..........#.#..................#................................#.......#.#........#....#....#...............\n" +
                ".......#............#....................................#..#.....##...............................#........##...........#........\n" +
                "......#..................................................#.....#..................#......................................#........\n" +
                "....................................................................................................#...#.......#.............#...\n" +
                ".....#...................................................#...........#...##........##.................................#...........\n" +
                "........................#..........................#...............#.......#............#..#..........##..............#...........\n" +
                ".....................#...................................#.........................#..............#......#..................#.....\n" +
                ".........#.#....#.....#...................................#....................................#..................................\n" +
                ".........#.#......#.........................#............................................#...#...................................#\n" +
                ".........................................#.#...............................#..............#..............................#........\n" +
                "#...........#...................#.....#..................#.........#...#...................#.............................##.....#.\n" +
                "#....#..........#............#................................#...#............##.....#....................#......................\n" +
                "#.................................##...#........#..............#.......#..........#....................................#.........#\n" +
                "..............#...#...............................................#................#........#...#.................#......#........\n" +
                "..............#.....................#.....#...........#............#...#.......##.........................##.#....................\n" +
                "....#............................................##...................#.......................................#........#..........\n" +
                ".................................................................................#...#............................................\n" +
                "....................................#...................#.........#......#.....#...#.............................#..............#.\n" +
                ".....#................................#................................#........................................................#.\n" +
                ".............................................#..........##........#.........#..........................#..........................\n" +
                "...............#..#...........#.......#........................#.........#.....................................................##.\n" +
                "...#....................#.........................#..#............................#...........#..#...#...............#............\n" +
                "........#.....................................#.......................................................#...#..#.........#.#......#.\n" +
                "...........................................#...............#............................................................#.....#...\n" +
                ".........................................#.....#............##......................#..............................#..............\n" +
                "..#...............#.............................#............................#.........#.......#..................................\n" +
                "..............................................................................................................#.............#....#\n" +
                "..................#.#.............#......................................#.......#...............#..........#.....................\n" +
                "........................#.#.......#..........#...#......#.........#......#.................#........#.......#............#....#.#.\n" +
                "..#.....................................................................#......................#...............#..................\n" +
                "..................................................................#......#............................#........#........#.........\n" +
                "......................................#.....................#..................#..............#...................................\n" +
                "................#..#.....................................................#....................................#..........#........\n" +
                "...................................#........................................#.#..#............................................##..\n" +
                "...............................#.........................#..........................#............................#.........#......\n" +
                "............................#........#..............#.............#.#........................................................#....\n" +
                "................#..................#.....#......................#.....................................................#...........\n" +
                "......................#........#............#..................#...............#...............#..................................\n" +
                "......................................................#..................................................#........................\n" +
                "................#.......#..................................................................#......................................\n" +
                "....................................#....#...............#........................................................................\n" +
                ".................................................................................................#...#.#..........................\n" +
                ".......#..#...........#.....#...............................................................................#..............#......\n" +
                "...#.................#.................^...................#.....#................................................................\n" +
                "...............#.............................................................................#.................................#..\n" +
                "............................................#.....#............................................................#.#........##......\n" +
                "................................#................................#.......#..#......#...................#......#..............#....\n" +
                "...................##...........................................................#.................................................\n" +
                "...........................#...................#..........#...................................#............#.............#...#....\n" +
                ".....#........................#...............#..#.#.......#...................................#.##...............#...#...........\n" +
                "...#.....................#.#.......................#..........#.............................................................#.....\n" +
                ".......#.........................................#.........#.............#....................##...........................#......\n" +
                ".......................................##...........#.................#.......................................#..................#\n" +
                "................................#.......#..........................#........#.#........#..........#...........#....##.............\n" +
                ".......#............#....#....................................#.....#...............#.............................................\n" +
                "..........#.................#............................................................................#.............#....#...#.\n" +
                "...#.......................#.................................................................................................#....\n" +
                ".......................#....#..........................................................................................#..........\n" +
                "......................................................................#...............................#............#....#.........\n" +
                ".....#..............................................................................#............#...........................#....\n" +
                "..#.............#..#.............#...#............................................................................................\n" +
                "....................................................#.......#.............................#....#............#...................#.\n" +
                "....................................................................#.#...#....................................#..........#.......\n" +
                "......#...#................#.........#.................##......................#........................#.........................\n" +
                ".............#.#...........#..........................................................................#...........................\n" +
                "..........#.....#........#........................................................................#.#.................#...........\n" +
                "..........#.##....................................#......#................#..........#..........#.......##.....#..................\n" +
                ".............................#................................................................##.............#....................\n" +
                "....................................#.................................................................................###.........\n" +
                "..................................#..........#...................................#......#.........................................\n" +
                "...............#...........#.............................................#......#...................................#.............\n" +
                "...............#...#...................................................#...................#............#...................#.....\n" +
                "........................................#......#.............#........#..........................#....#.....#..................#..\n" +
                ".......................#......................................................................#.......#...................#.....##\n" +
                ".................#.....................#............#............................#..........#......................#..............\n" +
                "....................#................................................................#................#......#.#..................\n" +
                ".#............#...............................................#..#......##.#................................##....#...............\n" +
                ".#.......#..........................................................................................................#.............\n" +
                ".................#............#...............................................................................#...................\n" +
                ".................................##......................................#.........................#................#.............\n" +
                "...................#.............................................................#................................................\n" +
                "...#.....#..#......#........#....#.................#..................#..#......................................#...........#...#.\n" +
                ".#.....................#...........................................................................#............................#.\n" +
                ".#............................#.........#...............................................#.........................................\n" +
                "....#......................#......................#....#........#.....#...................................#......................#\n" +
                ".......#.................#..............................#.....#......................#...............#..............#.......#.....\n" +
                "...#.................................................................................................#........#.....#......#......\n" +
                "......##...................................................................................#................................#.....\n" +
                "..........#................................#..................................#.................................................#.\n" +
                "...........#........#..............#...#..............#...................................................#......#.........#......\n" +
                ".......#...#....................................#..##.........................................................#...................\n" +
                "...........#............................................##..........#..#.#.....................................................#..\n" +
                "...................................#............................#..............#..#..................................#............\n" +
                "....#.......#...............#...........................................................................#.........................\n" +
                "...............#.....................................................................................................#............\n" +
                "................#..........................................#...............##...........................#....#..........#.........\n" +
                "...........................................#...................................................................................#..\n" +
                ".................#..........................................................................#.....#.............##..........#.....\n" +
                "...............#..................#................................#.......................#...#.....##...........................\n" +
                ".............#.......................#.......#.............#.#...#......#..............#.............................#.#..........\n" +
                "..........##....#..#..............................#...............................................................................\n" +
                ".................#......#.......#.....#..........#.............................#......................#.....#.....................\n" +
                "....#........#....................#.#.........#.#..........#......................................................................\n" +
                "...........................#.......#........#.........................#.#.................#........#...............#......#.......\n" +
                "#..#..................#...........#.....................................................................................#.........\n" +
                "......#...#.#...........#.....................................................#................#..#............#..................\n" +
                "................##.#...#..............#..............................#............................................................\n" +
                "...........................................................................................#.............................#........\n" +
                ".......#....#...................#..........................................................#............#............#.....#......\n" +
                ".............#....#..................................#....#........#.....................................#.#....#..............#.#\n" +
                ".#..................................................#...................#...............#.........................................\n" +
                "...#........#..................................#............#.#.......................................#...........................\n" +
                "................#.....#....................................#.#.#...........#......##................#.................#......#....\n" +
                "...#.......................#...........#...#...........#.#........................#..#.................##.....#...................\n" +
                ".............#.......................................#................#....#..#..#.....................#...#............#.........\n" +
                "..........#..................#............#...#..................#................................................................\n" +
                ".........#..........#.....................#..#................#.......................#.........#.......##..#.#....#.....#....#...\n" +
                "#..........................#.#...........#.#.........#............................................................................\n" +
                "..................#.....................#......#.##...................#................................................#..#.......\n" +
                ".....#....#......#..#............................##.........................................................#.....#.......#...##..\n" +
                "....#...#.#...##..................#..........................................................#.....#..............................\n" +
                "..............................#............#...........#..................................#....#............#.......#.............\n" +
                "....................................#.....................#............................#..............#...........................\n" +
                "............#............#..........#....##....................................#..#.....#..................#......................";

        String input1 = "....#.....\n" +
                ".........#\n" +
                "..........\n" +
                "..#.......\n" +
                ".......#..\n" +
                "..........\n" +
                ".#..^.....\n" +
                "........#.\n" +
                "#.........\n" +
                "......#...";

        String[] split = input.split("\\n");
        char[][] map = new char[split.length][split[0].length()];
        Character[][] map1 = new Character[split.length][split[0].length()];

        for (int i = 0; i < split.length; i++) {
            for (int j = 0; j < split[i].toCharArray().length; j++) {
                map[i][j] = split[i].charAt(j);
                map1[i][j] = split[i].charAt(j);
            }
        }
        int step = solutionForPartOne(map);
        System.out.println(step);

        int answer2 = solutionForPartTwo(map1);
        System.out.println(answer2);
    }

    static char GUARD = '^';
    static char WALL = '#';
    static int[][] DIR = new int[][]{
            {0, -1},
            {1, 0},
            {0, 1},
            {-1, 0}
    };
    static int LENGTH_X = 0;
    static int LENGTH_Y = 0;
    static char MARK = 'X';

    public static int solutionForPartOne(char[][] map) {
        int x = 0;
        int y = 0;
        LENGTH_Y = map.length;
        LENGTH_X = map[0].length;
        for (int i = 0; i < map.length; i++) {
            for (int j = 0; j < map[i].length; j++) {
                if (Objects.equals(map[i][j], GUARD)) {
                    x = j;
                    y = i;
                }
            }
        }
        map[y][x] = MARK;
        dfs(map, x, y, 0);
        return RES;
    }

    static int RES = 0;

    public static void dfs(char[][] map, int x, int y, int dir) {
        int[] dirArr = DIR[dir];
        int nextX = x + dirArr[0];
        int nextY = y + dirArr[1];


        if (nextY >= LENGTH_Y || nextY < 0 || nextX >= LENGTH_X || nextX < 0) {
            RES++;
            return;
        }
        if (Objects.equals(map[nextY][nextX], WALL)) {
            dir = (dir + 1) > 3 ? 0 : dir + 1;
            dfs(map, x, y, dir);
        } else {
            if (!Objects.equals(map[nextY][nextX], MARK)) {
                RES++;
                map[nextY][nextX] = MARK;
            }
            dfs(map, nextX, nextY, dir);
        }
    }


    static char FAKE_WALL = '@';
    static int INIT_X;
    static int INIT_Y;

    public static int solutionForPartTwo(Character[][] map) {
        int x = 0;
        int y = 0;
        for (int i = 0; i < map.length; i++) {
            for (int j = 0; j < map[i].length; j++) {
                if (Objects.equals(map[i][j], GUARD)) {
                    x = j;
                    y = i;
                }
                if (map[i][j] == '.') {
                    map[i][j] = '_';
                }

            }
        }
        INIT_X = x;
        INIT_Y = y;


//        int loop = loop(map);
//        return loop;
        Set<String> haveBeen = new HashSet<>();
        dfs2(map, x, y, 0, false, haveBeen);
        return OBS_SET.size();
    }

    static int LIMIT = 10000;
    static String OBS_STR = "";
    static Set<String> OBS_SET = new HashSet<>();


    public static void dfs2(Character[][] map, int x, int y, int dir, boolean useFakeWall, Set<String> haveBeen) {
        int[] dirArr = DIR[dir];
        int nextX = x + dirArr[0];
        int nextY = y + dirArr[1];
        int nextDir = (dir + 1) % 4;

        if (haveBeen.contains(x + "," + y + "," + dir)) {
            OBS_SET.add(OBS_STR);
            return;
        }

        if (nextY >= LENGTH_Y || nextY < 0 || nextX >= LENGTH_X || nextX < 0) {
            return;
        }

        if (Objects.equals(map[nextY][nextX], WALL) || Objects.equals(map[nextY][nextX], FAKE_WALL)) {
            dfs2(map, x, y, nextDir, useFakeWall, haveBeen);
        } else {
            if (!useFakeWall) {
                // The obstacle cannot be placed where the guard has already walked, as the obstacle is initially positioned before the guard begins to walk.
                boolean flag = true;
                for (String s : haveBeen) {
                    if (s.startsWith(nextX + "," + nextY)) {
                        flag = false;
                        break;
                    }
                }
                if (flag) {
                    OBS_STR = nextX + "," + nextY;
                    Character[][] copyMap = Day16.deepCopyArray(map);
                    copyMap[nextY][nextX] = FAKE_WALL;
                    Set<String> haveBeenTemp = new HashSet<>(haveBeen);

                    dfs2(copyMap, x, y, nextDir, true, haveBeenTemp);

                    OBS_STR = "";
                }

            }
            map[y][x] = MARK;
            haveBeen.add(x + "," + y + "," + dir);
            dfs2(map, nextX, nextY, dir, useFakeWall, haveBeen);
        }
    }

    public static int loop(Character[][] map) {
        int loops = 0;
        for (int i = 0; i < LENGTH_Y; i++) {
            for (int j = 0; j < LENGTH_X; j++) {
                if (map[i][j] != '.') {
                    continue;
                }

                // clone the map and set the current cell to an obstacle
                Character[][] copyMap = Day16.deepCopyArray(map);
                copyMap[i][j] = '@';

                // run the map until we run off the map or hit our step limit
                int steps = 0;
                int dir = 0;
                int x = INIT_X;
                int y = INIT_Y;

                while (steps < LIMIT) {
                    int[] dirArr = DIR[dir];
                    int nextX = x + dirArr[0];
                    int nextY = y + dirArr[1];

                    if (nextY >= LENGTH_Y || nextY < 0 || nextX >= LENGTH_X || nextX < 0) {
                        break;
                    }
                    if (Objects.equals(copyMap[nextY][nextX], WALL) || Objects.equals(copyMap[nextY][nextX], FAKE_WALL)) {
                        dir = (dir + 1) % 4;
                        continue;
                    } else {
                        x = nextX;
                        y = nextY;
                    }
                    steps++;
                }

                // if we hit our step limit, assume we've found a loop
                if (steps >= LIMIT) {
                    loops++;
                }
            }
        }
        return loops;
    }


    static class PointAndDir {
        private int x;
        private int y;
        private int dir;

        public PointAndDir(int x, int y, int dir) {
            this.x = x;
            this.y = y;
            this.dir = dir;
        }

        public int getX() {
            return x;
        }

        public void setX(int x) {
            this.x = x;
        }

        public int getY() {
            return y;
        }

        public void setY(int y) {
            this.y = y;
        }

        public int getDir() {
            return dir;
        }

        public void setDir(int dir) {
            this.dir = dir;
        }

        @Override
        public boolean equals(Object o) {
            if (o == null || getClass() != o.getClass()) return false;
            PointAndDir that = (PointAndDir) o;
            return x == that.x && y == that.y && dir == that.dir;
        }

        @Override
        public int hashCode() {
            return Objects.hash(x, y, dir);
        }

        @Override
        public String toString() {
            return "PointAndDir{" +
                    "x=" + x +
                    ", y=" + y +
                    ", dir=" + dir +
                    '}';
        }
    }
}


// https://observablehq.com/collection/@jwolondon/xadvent-of-code-2024

